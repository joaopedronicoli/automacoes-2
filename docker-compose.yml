version: "3.7"

services:
  backend:
    image: automacoes-backend:latest

    networks:
      - network_public

    environment:
      # App
      - NODE_ENV=${NODE_ENV}
      - PORT=${PORT}
      - APP_URL=${APP_URL}
      - FRONTEND_URL=${FRONTEND_URL}

      # Database
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_SYNCHRONIZE=${DATABASE_SYNCHRONIZE:-true}

      # Redis
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_DB=${REDIS_DB}
      - REDIS_PASSWORD=${REDIS_PASSWORD}

      # Queue
      - QUEUE_REDIS_HOST=${QUEUE_REDIS_HOST}
      - QUEUE_REDIS_PORT=${QUEUE_REDIS_PORT}
      - QUEUE_REDIS_DB=${QUEUE_REDIS_DB}

      # Security
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}

      # JWT
      - JWT_SECRET=${JWT_SECRET}

      # WhatsApp OTP (Meta Cloud API)
      - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN}
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}

      # Email SMTP (AWS SES)
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_FROM=${SMTP_FROM}

      # Chatwoot
      - CHATWOOT_WEBHOOK_SECRET=${CHATWOOT_WEBHOOK_SECRET}

      # Facebook/Instagram
      - FACEBOOK_APP_ID=${FACEBOOK_APP_ID}
      - FACEBOOK_APP_SECRET=${FACEBOOK_APP_SECRET}
      - FACEBOOK_CALLBACK_URL=${FACEBOOK_CALLBACK_URL}

      # Google/YouTube
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_CALLBACK_URL=${GOOGLE_CALLBACK_URL}

      # TikTok
      - TIKTOK_CLIENT_KEY=${TIKTOK_CLIENT_KEY}
      - TIKTOK_CLIENT_SECRET=${TIKTOK_CLIENT_SECRET}
      - TIKTOK_CALLBACK_URL=${TIKTOK_CALLBACK_URL}

      # Rate Limit
      - RATE_LIMIT_TTL=${RATE_LIMIT_TTL}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX}

      # Posts Sync
      - POSTS_SYNC_INTERVAL_MINUTES=${POSTS_SYNC_INTERVAL_MINUTES}
      - MAX_POSTS_PER_ACCOUNT=${MAX_POSTS_PER_ACCOUNT}

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.jolu-backend.rule=Host(`jolu.ai`) && PathPrefix(`/api`)
        - traefik.http.routers.jolu-backend.entrypoints=websecure
        - traefik.http.routers.jolu-backend.priority=2
        - traefik.http.routers.jolu-backend.tls.certresolver=letsencryptresolver
        - traefik.http.routers.jolu-backend.service=jolu-backend
        - traefik.http.services.jolu-backend.loadbalancer.server.port=3000

  frontend:
    image: automacoes-frontend:latest

    networks:
      - network_public

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.jolu-frontend.rule=Host(`jolu.ai`)
        - traefik.http.routers.jolu-frontend.entrypoints=websecure
        - traefik.http.routers.jolu-frontend.priority=1
        - traefik.http.routers.jolu-frontend.tls.certresolver=letsencryptresolver
        - traefik.http.routers.jolu-frontend.service=jolu-frontend
        - traefik.http.services.jolu-frontend.loadbalancer.server.port=80

networks:
  network_public:
    external: true
